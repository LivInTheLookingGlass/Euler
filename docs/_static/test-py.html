<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Mocha Tests</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.2/debug/pyodide.js"></script>
    <link href="https://npmcdn.com/mocha@10.6.0/mocha.css" rel="stylesheet" />
    <script src="https://npmcdn.com/mocha@10.6.0/mocha.js"></script>
  </head>

  <body>
<!-- A container element for the visual Mocha results -->
    <div id="mocha"></div>

    <!-- Mocha setup and initiation code -->
    <script>
      mocha.setup('bdd');
      window.onload = function() {
        async function main() {
          return await loadPyodide();
        }
        let pyodideReadyPromise = main();
        pyodideReadyPromise.then(async () => {
          let pyodide = await pyodideReadyPromise;
          await pyodide.loadPackage("micropip");
          await pyodide.runPythonAsync(`
            import micropip
            await micropip.install(["sortedcontainers", "u-msgpack-python"])
            from pyodide.http import pyfetch
            response = await pyfetch("https://euler.oliviaappleton.com/_static/dist/python.tar.gz") # .zip, .whl, ...
            await response.unpack_archive() # by default, unpacks to the current dir
          `);
          for (let i = 1; i < 26; i += 1) {
            describe(`run test ${i}`, function() {
              this.timeout(Infinity);
              it('should return a value', async () => {
                let q = `${i}`.padStart(4, '0');
                const pyodide = await pyodideReadyPromise;
                const answer = await pyodide.runPythonAsync(`
                  from src import p${q}
                  p${q}.main()
                `);
                if (answer === null || answer === undefined) {
                  throw new Error();
                }
                done();
              });
            });
          }
          var runner = mocha.run();
          var failedTests = [];
          runner.on('end', function() {
            window.mochaResults = runner.stats;
            window.mochaResults.reports = failedTests;
          });
          runner.on('fail', logFailure);

          function logFailure(test, err){
            var flattenTitles = function(test){
              var titles = [];
              while (test.parent.title){
                titles.push(test.parent.title);
                test = test.parent;
              }
              return titles.reverse();
            };

            failedTests.push({
              name: test.title,
              result: false,
              message: err.message,
              stack: err.stack,
              titles: flattenTitles(test)
            });
          };
        });
      };
    </script>
  </body>
</html>

